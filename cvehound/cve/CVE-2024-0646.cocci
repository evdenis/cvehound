/// Files: net/tls/tls_sw.c include/linux/skmsg.h
/// Fix: c5a595000e2677e865a39f249c056bc05d6e55fd
/// Fixes: d829e9c4112b52f4f00195900fd4c685f61365ab

virtual detect

@copybreak@
symbol copybreak;
typedef u32;
@@

struct sk_msg_sg {
	...
*	u32 copybreak;
	...
};

@err_copybreak depends on copybreak@
identifier msg_pl, part;
position p;
@@

\(tls_sw_sendmsg_splice\|tls_sw_do_sendpage\|tls_sw_sendpage\)(...)
{
	...
*	sk_msg_page_add@p(msg_pl, ..., part, ...);
	... when != msg_pl->sg.copybreak = 0;
*	sk_mem_charge(..., part);
	...
}

@curr@
symbol curr;
typedef u32;
@@

struct sk_msg_sg {
	...
*	u32 curr;
	...
};

@err_curr depends on curr@
identifier msg_pl, part;
position p;
@@

\(tls_sw_sendmsg_splice\|tls_sw_do_sendpage\|tls_sw_sendpage\)(...)
{
	...
*	sk_msg_page_add@p(msg_pl, ..., part, ...);
	... when != msg_pl->sg.curr = msg_pl->sg.end;
*	sk_mem_charge(..., part);
	...
}


@script:python depends on detect@
p << err_copybreak.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2024-0646')

@script:python depends on detect@
p << err_curr.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2024-0646')
