/// Files: drivers/net/tun.c
/// Fix: 96aa1b22bd6bb9fccf62f6261f390ed6f3e7967f
/// Fixes: 90e33d45940793def6f773b2d528e9f3c84ffdc7

virtual detect

@err exists@
identifier tun, frags;
statement S;
position p;
@@

tun_get_user(struct tun_struct *tun, ...)
{
	... when any
	switch (tun->flags & TUN_TYPE_MASK) {
	case IFF_TAP:
		... when != pskb_may_pull(..., ETH_HLEN)
*		eth_type_trans(..., tun->dev)@p
		...
		break;
	}
	...
	if (frags) {
		... when != skb_push(..., ETH_HLEN)
*		eth_get_headlen(...)
		...
	} else S
	... when any
}

@script:python depends on detect@
p << err.p;
@@

coccilib.report.print_report(p[0], 'ERROR: CVE-2021-0342')
